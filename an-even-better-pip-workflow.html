<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="A blog about a mixture of hobbies, work, and other interests">
	<meta property="og:description" content="A blog about a mixture of hobbies, work, and other interests">
	<meta property="og:title" content="An Even Better Pip Worflow™" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://blog.leverstone.me/an-even-better-pip-workflow.html" />
		<meta property="og:image" content="https://blog.leverstone.me/images/me.jpg" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>Tom Leverstone | Blog</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/poole.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/syntax.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/youtube.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/style.css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

		<!-- RSS -->
		<link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
	</head>

	<body class="theme-base-99">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<img class="profile-picture" src="https://blog.leverstone.me/images/me.jpg">
					Tom Leverstone
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead">A blog about a mixture of hobbies, work, and other interests </p>
			<p></p>
		</div>
		<nav class="sidebar-nav">
					<a class="sidebar-nav-item" href="https://leverstone.me" rel="me">
						<i class="fa fa-home"></i>
					</a>
					<a class="sidebar-nav-item" href="https://github.com/Nagasaki45" rel="me">
						<i class="fa fa-github"></i>
					</a>
					<a class="sidebar-nav-item" href="https://twitter.com/nagasaki45" rel="me">
						<i class="fa fa-twitter"></i>
					</a>
					<a class="sidebar-nav-item" href="mailto:tleverstone@gmail.com">
						<i class="fa fa-envelope"></i>
					</a>
			<a class="sidebar-nav-item" href="feeds/all.atom.xml">
				<i class="fa fa-feed"></i>
			</a>
		</nav>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">An Even Better Pip Worflow™</h1>
	<span class="post-date">Fri 04 November 2016</span>
	<p>The 9th major version of <a class="reference external" href="https://pypi.python.org/pypi/pip"><tt class="docutils literal">pip</tt></a>, the recommended tool for installing python packages, was released two days ago. I took a short look on <a class="reference external" href="https://pip.pypa.io/en/stable/news/">the changelog</a> to see what's new. At first, I couldn't notice anything that will change my current workflows. Usually, the important changes are listed first, but there was nothing groundbreaking there. However, I kept reading, to find this:</p>
<ul class="simple">
<li>Add <em>--not-required</em> option to <tt class="docutils literal">pip list</tt> to list packages that are not dependencies of other packages.</li>
</ul>
<p>In &quot;<a class="reference external" href="http://www.kennethreitz.org/essays/a-better-pip-workflow">A Better Pip Workflow™</a>&quot;, Kenneth Reitz describes a problematic aspect of dependencies management in python. Usually, we &quot;freeze&quot; the state of the dependencies of a project with <tt class="docutils literal">pip freeze &gt; requirements.txt</tt> to reproduce the exact environment later with <tt class="docutils literal">pip install <span class="pre">-r</span> requirements.txt</tt>. The problem starts when you want to upgrade these dependencies. Take this <a class="reference external" href="https://github.com/Nagasaki45/blog">blog dependencies</a> for example.</p>
<div class="highlight"><pre><span></span>$ pip list
blinker <span class="o">(</span><span class="m">1</span>.4<span class="o">)</span>
docutils <span class="o">(</span><span class="m">0</span>.12<span class="o">)</span>
feedgenerator <span class="o">(</span><span class="m">1</span>.8<span class="o">)</span>
Jinja2 <span class="o">(</span><span class="m">2</span>.8<span class="o">)</span>
MarkupSafe <span class="o">(</span><span class="m">0</span>.23<span class="o">)</span>
pelican <span class="o">(</span><span class="m">3</span>.6.0<span class="o">)</span>
pelican-readtime <span class="o">(</span><span class="m">0</span>.1.2<span class="o">)</span>
pelican-youtube <span class="o">(</span><span class="m">0</span>.2.0<span class="o">)</span>
pip <span class="o">(</span><span class="m">9</span>.0.0<span class="o">)</span>
Pygments <span class="o">(</span><span class="m">2</span>.1.3<span class="o">)</span>
python-dateutil <span class="o">(</span><span class="m">2</span>.5.3<span class="o">)</span>
pytz <span class="o">(</span><span class="m">2016</span>.4<span class="o">)</span>
setuptools <span class="o">(</span><span class="m">28</span>.8.0<span class="o">)</span>
six <span class="o">(</span><span class="m">1</span>.10.0<span class="o">)</span>
Unidecode <span class="o">(</span><span class="m">0</span>.4.19<span class="o">)</span>
</pre></div>
<p>Ideally, I would like to manage only the packages I call directly from code / command line (let's call them the &quot;top most dependencies&quot; from now on), and let them manage their dependencies for me. Therefore, I would have to read this output carefully to decide what to upgrade: &quot;did I install Pygments? and what about docutils? I know for sure that pelican-youtube was installed manually, so let's <tt class="docutils literal">pip install <span class="pre">--upgrade</span> <span class="pre">pelican-youtube</span></tt>&quot; and so forth...</p>
<p>Kenneth's recommendation to simplify the upgrade process is to keep two requirements files, the 1st includes all of the dependencies with their versions (<tt class="docutils literal">pip freeze &gt; requirements.txt</tt>), and the 2nd, <tt class="docutils literal"><span class="pre">requirements-to-freeze.txt</span></tt> should be <strong>managed manually</strong> to contain the top most dependencies. When it's time for an upgrade, call <tt class="docutils literal">pip install <span class="pre">-r</span> <span class="pre">requirements-to-freeze.txt</span> <span class="pre">--upgrade</span></tt>. Just don't forget to run <tt class="docutils literal">pip freeze &gt; requirements.txt</tt> immediately afterwards!</p>
<p>With the flag introduced in <tt class="docutils literal">pip</tt> 9.0.0, there is no more need for the <tt class="docutils literal"><span class="pre">requirements-to-freeze.txt</span></tt> file. To find out which packages should be upgraded run <tt class="docutils literal">pip list <span class="pre">--not-required</span></tt>. However, there are still some caveats to note:</p>
<ol class="arabic simple">
<li>The <tt class="docutils literal"><span class="pre">--not-required</span></tt> flag is implemented for <tt class="docutils literal">pip list</tt> and not for <tt class="docutils literal">pip freeze</tt>. They have different format. When the later is suitable for requirement files the former is not. Here is a <a class="reference external" href="https://github.com/pypa/pip/issues/4088">github issue</a> to implement the same flag for <tt class="docutils literal">pip freeze</tt>.</li>
<li>Assuming that the previous issue will be solved, I couldn't find a <strong>nice</strong> (read as &quot;no bash scripting&quot;) way to pipe the output of <tt class="docutils literal">pip freeze <span class="pre">--not-required</span></tt> to <tt class="docutils literal">pip install <span class="pre">--upgrade</span></tt>. There is still an intermediate phase of creating a temporary <tt class="docutils literal"><span class="pre">requirements-to-freeze.txt</span></tt> file.</li>
<li>Until the first issue will be resolved, we will upgrade <tt class="docutils literal">pip</tt> and <tt class="docutils literal">setuptools</tt> with our top most dependencies. The reason is that they are listed by <tt class="docutils literal">pip list</tt> but not by <tt class="docutils literal">pip freeze</tt>.</li>
<li>We will probably want to strip the version numbers from the output of <tt class="docutils literal">pip list <span class="pre">--not-required</span></tt>. It is meaningless to ask pip to upgrade but state the old versions in the same time.</li>
</ol>
<div class="section" id="demo-time">
<h2>Demo time!</h2>
<p>Let's try things out by updating this blog dependencies! First, let's see the top most dependencies:</p>
<div class="highlight"><pre><span></span>$ pip list --not-required
pelican <span class="o">(</span><span class="m">3</span>.6.0<span class="o">)</span>
pelican-readtime <span class="o">(</span><span class="m">0</span>.1.2<span class="o">)</span>
pelican-youtube <span class="o">(</span><span class="m">0</span>.2.0<span class="o">)</span>
pip <span class="o">(</span><span class="m">9</span>.0.0<span class="o">)</span>
setuptools <span class="o">(</span><span class="m">28</span>.8.0<span class="o">)</span>
</pre></div>
<p>OK. Considering the caveats above, we will need some bash scripting here. First, we want to remove the versions from the output. <tt class="docutils literal">sed</tt> might be our friend here. Let's try to use it to remove the versions completely by taking everything from the space to the end of the line and replacing it by an empty string:</p>
<div class="highlight"><pre><span></span>$ pip list --not-required <span class="p">|</span> sed <span class="s1">&#39;s/ .*//&#39;</span>
pelican
pelican-readtime
pelican-youtube
pip
setuptools
</pre></div>
<p>Great! Let's pass this to <tt class="docutils literal">pip install <span class="pre">--upgrade</span></tt>:</p>
<div class="highlight"><pre><span></span>$ pip install --upgrade <span class="sb">`</span>pip list --not-required <span class="p">|</span> sed <span class="s1">&#39;s/ .*//&#39;</span><span class="sb">`</span>
...
Successfully installed feedgenerator-1.9 pelican-3.6.3 pytz-2016.7
</pre></div>
<p>That's all. The top most dependencies were upgraded.</p>
</div>

</div>
		</div>
	</body>
</html>