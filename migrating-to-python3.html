<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="A blog about a mixture of hobbies, work, and other interests">
	<meta property="og:description" content="A blog about a mixture of hobbies, work, and other interests">
	<meta property="og:title" content="Migrating to python3" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://blog.leverstone.me/migrating-to-python3.html" />
		<meta property="og:image" content="https://blog.leverstone.me/images/me.jpg" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>Tom Leverstone | Blog</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/poole.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/syntax.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/youtube.css" />
		<link rel="stylesheet" href="https://blog.leverstone.me/theme/css/style.css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

		<!-- RSS -->
		<link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
	</head>

	<body class="theme-base-99">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<img class="profile-picture" src="https://blog.leverstone.me/images/me.jpg">
					Tom Leverstone
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead">A blog about a mixture of hobbies, work, and other interests </p>
			<p></p>
		</div>
		<nav class="sidebar-nav">
					<a class="sidebar-nav-item" href="https://leverstone.me" rel="me">
						<i class="fa fa-home"></i>
					</a>
					<a class="sidebar-nav-item" href="https://github.com/Nagasaki45" rel="me">
						<i class="fa fa-github"></i>
					</a>
					<a class="sidebar-nav-item" href="https://twitter.com/nagasaki45" rel="me">
						<i class="fa fa-twitter"></i>
					</a>
					<a class="sidebar-nav-item" href="mailto:tleverstone@gmail.com">
						<i class="fa fa-envelope"></i>
					</a>
			<a class="sidebar-nav-item" href="feeds/all.atom.xml">
				<i class="fa fa-feed"></i>
			</a>
		</nav>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">Migrating to python3</h1>
	<span class="post-date">Sat 25 June 2016</span>
	<p>I was recently asked, by my boss, about the possible benefits of migrating our
code base at work from python 2.6 to python 3. Instead of sending an email back
to my boss with my answer, I decided that it worth a blog post. Why? because the
internet is full with comparisons between python 2 and python 3, but it is hard
to tell what are the real gains from doing the migration. Here, I will try to
explain, in a very subjective manner, the benefits I see from such move.</p>
<p>So let's start with the obvious, <strong>python 3 is clearly a better language than
python 2.6</strong>: <tt class="docutils literal">print</tt> is a function instead of a statement, now with sane
arguments; dict and set comprehensions reduce unnecessary, error prone,
verbosity; real division by default, because that's what you want 99% of the
time anyway; iterators by default (<tt class="docutils literal">range</tt> replaced <tt class="docutils literal">xrange</tt>,
<tt class="docutils literal">dict.items()</tt> replaced <tt class="docutils literal">dict.iteritems()</tt>, etc.); explicit relative
imports... Actually, the list goes on and on. However, I <strong>don't</strong> think that
the features above are good reasons to migrate a large project. Modern python
code, written with python 3 in mind, will benefit from them, that's for sure. But
we do not want to rewrite our code base, we want the transition to be as smooth
as possible.</p>
<p>So what <strong>is</strong> valuable? Here is my list:</p>
<div class="section" id="we-must-leave-python-2-6">
<h2>We must leave python 2.6</h2>
<p>Our server is based on <a class="reference external" href="https://pypi.python.org/pypi/Twisted">twisted</a>, which already dropped support for python 2.6.
Our other main dependency is <a class="reference external" href="http://www.sqlalchemy.org/">SQLAlchemy</a>. I don't think that they are going to
drop support for python 2.6 anytime soon but this day will surely come. In
general, staying with python 2.6 will soon mean that for each dependency upgrade
we will have to upgrade everything at once, which is kind of a nightmare.</p>
<p>So, if we must leave python 2.6 behind and upgrade, I really don't think that
migrating to python 3.5, for example, will be way too complicated than to 2.7.
Moreover, moving to python 2.7 now will require another migration, with similar
effort, in the next 4 years.</p>
</div>
<div class="section" id="what-features-do-worth-the-upgrade">
<h2>What features do worth the upgrade</h2>
<div class="section" id="exception-chaining">
<h3><a class="reference external" href="https://www.python.org/dev/peps/pep-3134/">Exception chaining</a></h3>
<p>In python 3, when an exception is raised from within an <tt class="docutils literal">except</tt> block, it is
concatenated to the former exception, and the traceback of both is available to
whoever catch them. That way, we can always be sure that our top most logging
system will log the entire traceback, even if the latest exception &quot;mask&quot; the
original one.</p>
<p>This feature could solve us several debugging hours. Even more, I'm sure that we
gave up on lots of bugs we couldn't investigate properly, as the original
exception was lost due to a bug in the <tt class="docutils literal">except</tt> block.</p>
</div>
<div class="section" id="unorderable-types">
<h3><a class="reference internal" href="#unorderable-types">Unorderable types</a></h3>
<p>If something is broken, I prefer it to raise exception as soon as possible. In
python 2, the following won't fail!</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="c1"># python2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;hello&#39;</span> <span class="o">&lt;</span> <span class="mi">1</span>
</pre></div>
<p>WTF?!? Why should anyone allow comparison between a string and an int!?!
Moreover, what is the result, <tt class="docutils literal">True</tt> or <tt class="docutils literal">False</tt>? In python 3 this issue was
solved for good:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="c1"># python3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;hello&#39;</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">unorderable</span> <span class="n">types</span><span class="p">:</span> <span class="nb">str</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">()</span>
</pre></div>
<p>Again, we saw such bugs before in our system, and they are hard to spot. Having
the language solve this corner for us will be great.</p>
</div>
<div class="section" id="list-comprehensions-that-doesn-t-leak">
<h3>List comprehensions that doesn't leak</h3>
<p>Again, another source for nasty bugs.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="c1"># python2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">42</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">squares</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">9</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="c1"># python3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">42</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">squares</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">42</span>
</pre></div>
</div>
</div>
<div class="section" id="and-much-more">
<h2>And much more</h2>
<p>Apart from new features there are the plethora of packages that we can't use
with python 2.6. External dependencies gradually drop support, while the
standard library continuously improves with new and shiny tools, such as
<tt class="docutils literal">concurrent.futures</tt> and <tt class="docutils literal">asyncio</tt>.</p>
</div>

</div>
		</div>
	</body>
</html>